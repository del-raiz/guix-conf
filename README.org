#+TITLE: Guix OS (System & Home) + StumpWM Configuration
#+subtitle: (defmacro guix-os (system home &key (stumpwm 'x11)) ...)
#+author: Erik P Almaraz (logoraz)
#+email: erikalmaraz@fastmail.com
:args:
#+language: en
#+options: ':t toc:nil author:t email:t num:t
#+startup: content indent
#+macro: latest-export-date '(eval (format-time-string "%F %T %z"))'
:end:

  My personal GNU Guix OS (System & Home) + StumpWM Configuration!

  [[file:./assets/guix+stumpwm_desktop.png]]

    This is specifically setup and trailed with my Lenovo ThinkPad X1 Carbon 4th
    Gen (Type 20FB) Laptop.

  Git Repositories:

  - GitHub: https://github.com/logoraz/guix-craft.git


* Guix OS Configuration

  This "Guix OS" Configuration is set up to act as its own distribution of the
  GNU Guix System Distribution - staging a polished StumpWM/X11 setup, and a complete
  set of packages & services needed. I also include my configurations for Emacs
  and Nyxt. All configurations are contained in the config directory.

  Guix OS is now fully deployed via Guix using =home-impure-symlinks-service-type=
  and staged as a distribution utilizing the new feature [[https://guix.gnu.org/manual/devel/en/html_node/Guix-Services.html#Guix-Home-Service][guix-home-service]] and
  specifying channels therein via a [[https://guix.gnu.org/manual/devel/en/html_node/Customizing-the-System_002dWide-Guix.html][system-wide channel configuration]]. All that is
  needed is to run =sudo guix system reconfigure guix-config.scm= and everything will be
  set up after initial Guix SD (nonguix) installation!

  While this is considered an 'impure' approach, I personally like my config files to be
  flexible as opposed to immutable. I am constantly experimenting and would rather have
  changes readily available - so I am open to a hybrid (aka "impure") approach when it
  comes to Guix on this front.

** Guix OS (System + Home + Channels)

I've set up my entire config in =guix-config.scm=, which comprises of System, Home, and the channels for both. This is done using =guix-home-service-type=. With this, I only need to call =guix system reconfigure guix-confic.scm=, which replaces =guix pull=, =guix home reconfigure=, and =guix system reconfigure=.
I am using channels subsitutes via =specifications->tranformations= function
I defined based on the Guix manual's prescription.

Define system-level services & packages:
- 1. =%system-services=
   - Set OpenSSH, CUPs, Screenlocker, and Bluetooth services
   - =%desktop-services= - modify-services to utilizes package substitutes now.
   - =guix-home-service-type= - concurrently updates home profile and packages.
     - Bug: https://lists.gnu.org/archive/html/bug-guix/2024-06/msg00085.html
- 2. =%stumpwm-packages= - Window Manager
  Note that packages are specified only as symbols and not using
  =specifications->packages=.
  SBCL, SBCL-*, StumpWM+Slynk and stumpwm-contrib installed at the system
  level.
  font.
  - =sbcl=
  - =sbcl-*=
  - =stumpwm+slynk=
  - =sbcl-stumpwm-*=
- 3. =%x11-util-packages= - Window System, X11 util packages and base fonts
  - =font-hack=
  - =font-jetbrains-mono=
  - =bluez=
  - =blueman=
  - =x*=

Define user-level services & packages - note packages are specified as
symbols, not using =specifications->packages=:
- 1. =%logoraz-packages= -> My everyday packages (fonts, apps, utils/tools)
- 2. =%emacs-packages= -> Use Guix to setup Emacs (it's all there!)
- 3. =services= -> wip (todo: modularize to separate variable definitions)
  - =home-environment-variables-service-type=
  - =home-dbus-service-type=
  - =home-pipewire-service-type=
  - =home-bash-service-type=
  - =home-impure-symlinks-service-type= via =home-impure-symlinks.scm=
    - TODO: find reference to original source
    - ref: https://github.com/aurtzy/guix-config

Current list of defined channels and whether they are active and/or pinned at a specific commit:
- Guix
- Nonguix
- guixrus
- flatwhatson
- rde
- benoitj
- aadcg

** Manifests (=./config/guix/manifests/=)
- =devtools-manifest.scm=  - Dev Packages in general and for Common Lisp
- =org-docs-manifest.scm=  - Latex packages for Org document generation

I use these manifests as follows for consistent environments with packages I
need without bloating my home configuration:

#+begin_src sh

  $ guix shell -m devtools-manifest.scm -- emacs
  # or
  $ guix shell -m org-docs-manifest.scm -- emacs

#+end_src

** Installation

Basic Instructions on how to install Guix System
*** Live Image/ISO

 I specifically used the guix-installer, but next time my give the
 =guix-live-image= a try... best to have both present for reference.
 Also note that one can use the nonguix images provided on item 3.

 1. [[https://github.com/SystemCrafters/guix-installer/releases/tag/v202308290335][GitHub:SystemCrafters/guix-installer/releases/tag/v202308290335]]

 2. https://github.com/SystemCrafters/guix-live-image

 3. https://gitlab.com/nonguix/nonguix/-/releases
    - https://gitlab.com/nonguix/nonguix

*** Create usb installation media

For a quick reference on how to create usb installation media:

- List information about block devices (i.e. see what disks you have and find
  your usb)

#+begin_src sh

  $ lsblk

#+end_src

- Create your usb installation media (note: =sdX -> sdb= for me)

#+begin_src sh

  $ sudo dd if=guix-installer-<date number>.iso of=/dev/sdX status=progress

#+end_src

*** Graphical Installer Procedure

Followed =SystemCrafters= prescription for installation:

- [[https://systemcrafters.net/craft-your-system-with-guix/full-system-install/][systemcrafters:craft-your-own-system-with-guix]]

** Deploy

*** Initial setup/deployment (WIP)

I've set up Guix OS such that I only need to clone this repo, after a
fresh Guix SD install (described above), and run a system reconfigure.
This is possible using =guix-home-service-type= to setup system and home
concurrently. Deployment of my configuration herein is possible using
=home-impure-symlinks-service-type=.

In the future I plan to refactor and make this setup modular by defining
modules appropriately and perhaps creating a channel. Ultimate goal is
have this setup be available as a custom Guix Distrobution that anyone
can deploy - though it is already set up this way for the most part,
I would like to take it one step further and create a bootable image.
See: https://systemcrafters.net/live-streams/january-13-2023/


#+begin_src sh

  # Get Guix OS Distrobution
  mkdir ~/repos/
  cd ~/repos
  git clone https://github.com/logoraz/guix-craft.git
  cd guix-craft/

  # Deploy/Install
  sudo guix system reconfigure guix-config.scm

#+end_src

*** Connecting to Wifi via CLI

Don't have yet a GUI for managing wifi connections in my StumpWM setup, so
typically connect via command line, and so putting here as a reminder to myself:

#+begin_src sh

  # List Wifi networks available
  $ sudo nmcli device wifi list

  # Connect to ESSID
  $ sudo nmcli device wifi connect <ESSID> password <network-password>

#+end_src

List known connections and delete them from list in Network Manager.

#+begin_src sh

  # Get ESSID (name) or UUID of connection to delete
  $ sudo nmcli connection show

  # Delete connection via ID (aka name or ESSID)
  $ sudo nmcli connection delete <ESSID>

#+end_src

** Common Lisp Stuff

Some Common Lisp stuff I've trialed out in Guix System:

*** ChemScribe
A work in progress of a Common Lisp (Clasp) application I am writing for
my line of chemistry work. Right now it is a base scaffolding and scratch
work as I learn more about Common Lisp...

Reference my repo: https://github.com/logoraz/ChemScribe

*** Clasp

The Clasp Common Lisp compiler is a project of extreme high interest to
me - Clasp is a new Common Lisp implementation that seamlessly
interoperates with C++ libraries and programs using LLVM for compilation
to native code. See: https://github.com/clasp-developers/clasp

They currently have a guix package recipe that hasn't yet made its way
upstream, as it has a bit complex build model due to git submodules:

I have it currently installed to my .guix-profle, but may resort to
installing it via guix shell only, so as to follow the "Guix way..."

Installation Instructions:

#+begin_src sh

  # Clone to a directory of your choice
  $ git clone https://github.com/clasp-developers/clasp.git \
    ~/repos/builds/clasp/

  $ cd ~/repos/builds/clasp/
  $ guix shell --pure git nss-certs sbcl -- ./koga
  # Note: Koga will error out after downloading the dependencies,
  # when trying to configure clasp.
  $ guix build -f guix/clasp.scm


  # Perhaps install via guix shell for the future
  # one caveat is that it will be removed once you perform guix gc
  # I have not yet trialed the below code:
  $ guix shell -D -f guix/clasp.scm
  # then you can invoke it with whatever program you'd like, say emacs:
  $ guix shell -D -f guix/clasp.scm -- emacs

#+end_src


* StumpWM Configuration

My personal StumpWM configuration - I prefer to follow the XDG-style configuration, as
prescribed on https://github.com/stumpwm/stumpwm/wiki/Customize. I like things modular,
so it is set up as such.

** Initialization File:  =~/.config/stumpwm/config=

Loads in modules and set's up core features, such as my X11 environment.

** Modules: =~/.config/stumpwm/modules/*=

These probably aren't qualified to be called modules, but they are akin to stand-alone
common-lisp scripts, they currently have a predefined order to be called in StumpWM
config.lisp -> config.
- =auto-start= - Setup X11 environment & controls
- =colors= - Define color pallet for StumpWM
- =syntax= - Helper Functions, and Macros for StumpWM (wip)
- =frames= - Frame/Window configurations
- =keybindings= - The heart and sole of the StumpWM configuration
- =modeline= - Setup & customize StumpWM modeline
- =theme= - Set appearance/style of StumpWM
- =utilities= - Utility packages/libraries, ad-hoc customizations & commands.

** Libraries: =~/.config/stumpwm/libraries/*=

These are personally developed StumpWM CL packages, to be loaded similarily
to StumpWM-Contrib packages. Note I've modiefied most of these contrib
packages slighly to suit my use needs and updated their package definitions
minimizing `:use` in place of `:import-from` as suggested by the
Common Lisp Cookbook best practices:
- =swm-wpctl= - Improved from stumpwm-wpctl
  - A fork of https://github.com/Junker/stumpwm-wpctl
  - configured/loaded in "utilities.lisp"
- =swm-bluetooth= - Modified from bluetooth found on Phundrak's blog
  - Borrowed from https://config.phundrak.com/stumpwm#bluetooth
  - configured/loaded in "utilities.lisp"
- =swm-screenshot= - Improved from stumpwm-contrib/util/screenshot
  - Enhanced functionality - no longer need to write path & filename
    into a prompt.
  - configured/loaded in "utilities.lisp"
- =stump-nmctl= - TODO: make a CL interface to nmcli for StumpWM
  - configured/loaded in "utilities.lisp"
- =swm-finder= - TODO: make a simple CL UI File System for StumWM using cl-gtk4
  - configured/loaded in "utilities.lisp"
- =end-session= - A la carte from stumpwm-contrib/util, staged for improvements
  - configured/loaded in "utilities.lisp"

** Guix [[https://github.com/stumpwm/stumpwm-contrib][stumpwm-contrib]] modules:
These are the =stumpwm-contrib= modules available in Guix that I am using.
- stumpwm-contrib/util:
  - =kbd-layouts=: configured/loaded in "keybindings.lisp"
  - =ttf-fonts=: configured/loaded in "theme.lisp"
  - =swm-gaps=: configured/loaded in "frames.lisp"
  - =global-windows= - configured/loaded in "config.lisp"
- stumpwm-contrib/modeline:
  - =cpu=: configured/loaded in "modeline.lisp"
  - =mem=: configured/loaded in "modeline.lisp"
  - =wifi=: configured/loaded in "modeline.lisp"
  - =battery-portable=: configured/loaded in "modeline.lisp"


* References


1. Guix System & Home Configuration:

   - [[https://systemcrafters.net/craft-your-system-with-guix/full-system-install/][Craft Your System with Guix - Full System Install]]

   - [[https://github.com/SystemCrafters/guix-installer][SystemCrafters: guix-installer]]

   - https://github.com/iambumblehead/guix-home

   - https://systemcrafters.net/live-streams/january-13-2023/

   - [[https://github.com/aurtzy/guix-config/blob/master/modules/my-guix/home/services.scm][Home Impure Symlinks Service]]

   - [[https://github.com/SystemCrafters/guix-installer/blob/master/guix/installer.scm][SystemCrafter Guix Installer Image]]

   - [[https://systemcrafters.net/live-streams/may-10-2024/][Guix Home Service & System-Wide Channels]]

   - [[https://github.com/abcdw/rde][Guix RDE Distrobution Mirror]]

2. StumpWM Configurations & Hacks:

    - https://config.phundrak.com/stumpwm

    - https://github.com/herbertjones/my-stumpwm-config

    - https://mail.gnu.org/archive/html/bug-guix/2023-04/msg00227.html
      - Believe this has since been corrected in Guix upstream.

3. Nyxt Configuration

   - https://nyxt.atlas.engineer/documentation

   - https://www.youtube.com/@nyxt-browser

4. Emacs & Guix

    - https://www.youtube.com/@systemcrafters

5. Xorg Response Lag solution

    - https://gitlab.com/nonguix/nonguix/-/issues/212

